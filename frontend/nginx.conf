server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  index index.html;

  # Security headers
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "no-referrer-when-downgrade" always;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

  # Health endpoint for loadbalancer
  location = /healthz {
    add_header Content-Type text/plain;
    return 200 "ok\n";
    access_log off;
  }

  # Static assets with optimized caching
  location /assets/ {
    try_files $uri =404;
    access_log off;
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";
  }

  # Favicon with long cache
  location = /favicon.ico {
    try_files $uri =404;
    access_log off;
    expires 1y;
    add_header Cache-Control "public, immutable";
  }

  # Manifest and service worker files
  location ~* \.(webmanifest|manifest\.json)$ {
    try_files $uri =404;
    add_header Cache-Control "no-cache";
    expires 0;
  }

  # SPA fallback for React Router - CRITICAL for avoiding 404s
  location / {
    try_files $uri $uri/ @fallback;
    
    # Add no-cache headers for HTML to prevent stale app versions
    location ~* \.html$ {
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires "0";
      try_files $uri @fallback;
    }
  }

  # Fallback location for SPA routing and error handling
  location @fallback {
    try_files /index.html =404;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
  }

  # Custom error pages to prevent 502 fallthrough
  error_page 500 502 503 504 @fallback;
  
  # Gzip compression with broader coverage
  gzip on;
  gzip_vary on;
  gzip_min_length 1024;
  gzip_comp_level 6;
  gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/javascript
    application/xml+rss
    application/json
    application/ld+json
    application/atom+xml
    image/svg+xml;

  # Additional optimizations
  client_max_body_size 10M;
  keepalive_timeout 65;
  server_tokens off;
}