name: CI/CD Flutter ‚Äî Optimized Pipeline

on:
  push:
    branches: [main, develop, 'feature/*', 'hotfix/*']
  pull_request:
    branches: [main, develop]
    paths:
      - 'lib/**'
      - 'test/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - 'android/**'
      - 'ios/**'
  schedule:
    # Scan s√©curit√© nocturne 02h UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  # Correction : utiliser Flutter 3.22.x (embarque Dart 3.8)
  FLUTTER_VERSION: '3.22.2'
  PUB_CACHE: ~/.pub-cache

# Optimisation concurrency: cancel-in-progress
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Permissions minimales : contents: read
permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  quality-analysis:
    name: üü¶ Qualit√© & Analyse Statique
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          
      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
            
      - name: Install dependencies
        run: flutter pub get
        
      - name: Verify Flutter installation
        run: flutter doctor -v
        
      - name: Analyze code
        run: flutter analyze --fatal-infos
        
      - name: Check formatting
        run: dart format --set-exit-if-changed .
        
      - name: Run dart fix --dry-run
        run: dart fix --dry-run

  tests-coverage:
    name: üü© Tests Unitaires & Couverture (‚â• 80% Codecov)
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          
      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
            
      - name: Install dependencies
        run: flutter pub get
        
      - name: Run tests with coverage
        run: flutter test --coverage
        
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage/lcov.info
          fail_ci_if_error: true
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build-validation:
    name: üü© Validation Build (matrix flavors)
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    strategy:
      matrix:
        flavor: [development, staging, production]
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          
      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
            
      - name: Install dependencies
        run: flutter pub get
        
      - name: Create env.json from secrets
        run: |
          echo '${{ secrets.ENV_JSON_${{ matrix.flavor }} }}' > assets/config/env.json
          
      - name: Build APK for ${{ matrix.flavor }}
        run: flutter build apk --flavor ${{ matrix.flavor }} --target lib/main_${{ matrix.flavor }}.dart
        
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.flavor }}-${{ github.sha }}
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 7

  security-scan:
    name: üü© Scan S√©curit√© Nocturne (TruffleHog + Snyk)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          
      - name: Install dependencies
        run: flutter pub get
        
      - name: Run Snyk security scan
        uses: snyk/actions/dart@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  deploy-production:
    name: üü© D√©ploiement Production (push main)
    runs-on: ubuntu-latest
    needs: [quality-analysis, tests-coverage, build-validation]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          
      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
            
      - name: Install dependencies
        run: flutter pub get
        
      - name: Create production env.json
        run: |
          echo '${{ secrets.ENV_JSON_PRODUCTION }}' > assets/config/env.json
          
      - name: Build App Bundle for Play Store
        run: flutter build appbundle --flavor production --target lib/main_production.dart
        
      - name: Deploy to Play Store
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          packageName: com.example.app.production
          releaseFiles: build/app/outputs/bundle/productionRelease/app-production-release.aab
          track: internal
          status: completed
          whatsNewDirectory: distribution/whatsnew
          mappingFile: build/app/outputs/mapping/productionRelease/mapping.txt

  notification-summary:
    name: üü© Notification finale (r√©sum√© global)
    runs-on: ubuntu-latest
    needs: [quality-analysis, tests-coverage, build-validation, deploy-production]
    if: always() && (github.event_name != 'schedule')
    
    steps:
      - name: Determine workflow status
        id: status
        run: |
          if [[ "${{ needs.quality-analysis.result }}" == "failure" || 
                "${{ needs.tests-coverage.result }}" == "failure" || 
                "${{ needs.build-validation.result }}" == "failure" || 
                "${{ needs.deploy-production.result }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=‚ùå" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "status=deployed" >> $GITHUB_OUTPUT
            echo "emoji=üöÄ" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
          fi
          
      - name: Send Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              attachments: [{
                color: '${{ steps.status.outputs.status == "failure" && "danger" || steps.status.outputs.status == "deployed" && "good" || "warning" }}',
                blocks: [
                  {
                    type: 'header',
                    text: {
                      type: 'plain_text',
                      text: '${{ steps.status.outputs.emoji }} CI/CD Flutter ‚Äî R√©sum√© Global'
                    }
                  },
                  {
                    type: 'section',
                    fields: [
                      {
                        type: 'mrkdwn',
                        text: `*Branch:* ${process.env.AS_REF}`
                      },
                      {
                        type: 'mrkdwn',
                        text: `*Commit:* <${process.env.AS_REPO}/commit/${process.env.AS_COMMIT}|${process.env.AS_COMMIT.slice(0,8)}>`
                      },
                      {
                        type: 'mrkdwn',
                        text: `*Qualit√©:* ${{ needs.quality-analysis.result == 'success' && '‚úÖ' || '‚ùå' }}`
                      },
                      {
                        type: 'mrkdwn',
                        text: `*Tests:* ${{ needs.tests-coverage.result == 'success' && '‚úÖ' || '‚ùå' }}`
                      },
                      {
                        type: 'mrkdwn',
                        text: `*Build:* ${{ needs.build-validation.result == 'success' && '‚úÖ' || '‚ùå' }}`
                      },
                      {
                        type: 'mrkdwn',
                        text: `*Deploy:* ${{ needs.deploy-production.result == 'success' && 'üöÄ' || needs.deploy-production.result == 'failure' && '‚ùå' || '‚è≠Ô∏è' }}`
                      }
                    ]
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}