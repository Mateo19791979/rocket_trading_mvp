name: Trading MVP CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

jobs:
  install-and-test:
    name: ðŸ”§ Installation & Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run lint (optional)
        run: npm run lint || echo "â„¹ï¸ pas de lint configurÃ©"
        
      - name: Run tests (optional)
        run: npm test || echo "â„¹ï¸ pas de tests configurÃ©s"

  build:
    name: ðŸ—ï¸ Build & Prepare
    needs: install-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Create backend env.json (secrets)
        run: |
          mkdir -p backend/config
          cat > backend/config/env.json <<'JSON'
          {
            "SUPABASE_URL": "${{ secrets.SUPABASE_URL }}",
            "SUPABASE_KEY": "${{ secrets.SUPABASE_KEY }}",
            "OPENAI_API_KEY": "${{ secrets.OPENAI_API_KEY }}",
            "CORS_ORIGIN": "https://trading-mvp.com"
          }
          JSON
          
      - name: Build frontend
        run: npm run build || echo "âœ… build step (optionnel)"
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trading-mvp-build
          path: |
            dist/
            backend/
          retention-days: 7

  security-check:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Run TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  deploy-staging:
    name: ðŸš€ Deploy to Staging
    needs: [build, security-check]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.trading-mvp.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: trading-mvp-build
          
      - name: Install Supabase CLI (optional migrations)
        run: |
          npm i -g supabase
          supabase db push --project-ref ${{ secrets.SUPABASE_PROJECT_REF_STAGING }} || echo "â„¹ï¸ no migrations to apply"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          
      - name: Deploy to staging server
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          # Add your staging deployment commands here
          echo "âœ… Staging deployment completed"

  deploy-production:
    name: ðŸ­ Deploy to Production
    needs: [build, security-check]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://trading-mvp.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: trading-mvp-build
          
      - name: Install Supabase CLI
        run: npm i -g supabase
        
      - name: Run database migrations
        run: supabase db push --project-ref ${{ secrets.SUPABASE_PROJECT_REF }} || echo "â„¹ï¸ no migrations to apply"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          
      - name: Deploy to production via SSH+rsync
        run: |
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
          # Deploy backend
          rsync -avz --delete backend/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/trading-mvp/backend
          
          # Deploy frontend (if built)
          if [ -d "dist" ]; then
            rsync -avz --delete dist/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/trading-mvp/frontend
          fi
          
          # Restart services
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
            cd /var/www/trading-mvp &&
            npm pkg set type=module >/dev/null 2>&1 || true &&
            cd backend &&
            npm i --omit=dev &&
            pm2 startOrReload ecosystem.config.cjs || (npm i -g pm2 && pm2 start ecosystem.config.cjs) &&
            pm2 save &&
            echo "âœ… Backend services restarted"
          '
          
      - name: Health check
        run: |
          sleep 10
          curl -fsS https://${{ secrets.PUBLIC_API_HOST }}/status || (echo "âŒ Health check failed" && exit 1)
          echo "âœ… Production deployment health check passed"

  notification:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging]
    if: always()
    steps:
      - name: Determine deployment status
        id: status
        run: |
          if [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
            echo "status=production-deployed" >> $GITHUB_OUTPUT
            echo "emoji=ðŸš€" >> $GITHUB_OUTPUT
            echo "message=Production deployment successful!" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.deploy-staging.result }}" == "success" ]]; then
            echo "status=staging-deployed" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ§ª" >> $GITHUB_OUTPUT
            echo "message=Staging deployment successful!" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.deploy-production.result }}" == "failure" || "${{ needs.deploy-staging.result }}" == "failure" ]]; then
            echo "status=deployment-failed" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=Deployment failed! Check logs." >> $GITHUB_OUTPUT
          else
            echo "status=no-deployment" >> $GITHUB_OUTPUT
            echo "emoji=â„¹ï¸" >> $GITHUB_OUTPUT
            echo "message=CI/CD pipeline completed (no deployment triggered)" >> $GITHUB_OUTPUT
          fi
          
      - name: Send notification (webhook example)
        if: always()
        run: |
          echo "${{ steps.status.outputs.emoji }} Trading MVP CI/CD Status: ${{ steps.status.outputs.message }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          
          # Uncomment and configure for Slack/Discord/Teams webhook
          # curl -X POST ${{ secrets.WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"${{ steps.status.outputs.emoji }} Trading MVP: ${{ steps.status.outputs.message }} (Branch: ${{ github.ref_name }})"}'