version: "3.9"

networks:
  web:
    external: false

services:
  traefik:
    image: traefik:v3.0
    container_name: mvp-traefik
    command:
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.file.filename=/etc/traefik/dynamic.yml
      - --providers.file.watch=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL:-admin@trading-mvp.com}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
      - --accesslog=true
      - --log.level=INFO
    ports:
      - "80:80" -"443:443"
    volumes:
      - traefik_letsencrypt:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
    networks: [web]
    labels:
      - "traefik.enable=true"
      # Global HTTP to HTTPS redirect
      - "traefik.http.routers.http-catchall.rule=HostRegexp(`{any:.+}`)"
      - "traefik.http.routers.http-catchall.entrypoints=web" -"traefik.http.routers.http-catchall.middlewares=redirect-to-https@docker" -"traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https" -"traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mvp-backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - SUPABASE_URL=${VITE_SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${VITE_SUPABASE_ANON_KEY}
      - INTERNAL_ADMIN_KEY=${VITE_INTERNAL_ADMIN_KEY}
      - PORT=8080
      - REDIS_URL=redis://redis:6379
      # ===== AI Providers (tous, pour éviter les erreurs de modules) =====
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY:-}
      # Sélection par défaut (fallback si un provider manque)
      - AI_PROVIDER_DEFAULT=${AI_PROVIDER_DEFAULT:-openai}
      - AI_TIMEOUT_MS=${AI_TIMEOUT_MS:-25000}
      # ===== IBKR (Paper) =====
      - IBKR_MODE=${IBKR_MODE:-paper}
      - IBKR_HOST=${IBKR_HOST:-127.0.0.1}
      - IBKR_PORT=${IBKR_PORT:-7497}
      - IBKR_CLIENT_ID=${IBKR_CLIENT_ID:-1}
      - IBKR_ACCOUNT=${IBKR_ACCOUNT:-DUN766038}
      - IBKR_READ_ONLY=${IBKR_READ_ONLY:-false}
      # ===== Sécurité exécution =====
      - MAX_POS_PER_SYMBOL=${MAX_POS_PER_SYMBOL:-1000}
      - MAX_NOTIONAL_PER_SYMBOL=${MAX_NOTIONAL_PER_SYMBOL:-25000}
      - MAX_LEVERAGE=${MAX_LEVERAGE:-2}
      - DAILY_LOSS_STOP=${DAILY_LOSS_STOP:--500}
    networks: [web]
    depends_on:
      - redis
    labels:
      - "traefik.enable=true"
      # Backend router pour /security avec priorité haute
      - "traefik.http.routers.backend-rls.rule=Host(`rockettra3991.builtwithrocket.new`) && PathPrefix(`/security`)"
      - "traefik.http.routers.backend-rls.entrypoints=websecure" -"traefik.http.routers.backend-rls.tls=true" -"traefik.http.routers.backend-rls.tls.certresolver=letsencrypt"
      # Priorité supérieure au catch-all du front
      - "traefik.http.routers.backend-rls.priority=100" -"traefik.http.services.backend-rls.loadbalancer.server.port=8080"
      # Router pour les APIs générales  
      - "traefik.http.routers.backend-api.rule=Host(`rockettra3991.builtwithrocket.new`) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend-api.entrypoints=websecure" -"traefik.http.routers.backend-api.tls=true" -"traefik.http.routers.backend-api.tls.certresolver=letsencrypt" -"traefik.http.routers.backend-api.priority=90" -"traefik.http.services.backend-api.loadbalancer.server.port=8080"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=https://rockettra3991.builtwithrocket.new/api
    container_name: mvp-frontend
    restart: unless-stopped
    networks: [web]
    labels:
      - "traefik.enable=true"
      # Catch-all pour le front, priorité plus basse
      - "traefik.http.routers.frontend.rule=Host(`rockettra3991.builtwithrocket.new`)"
      - "traefik.http.routers.frontend.entrypoints=websecure" -"traefik.http.routers.frontend.tls=true" -"traefik.http.routers.frontend.tls.certresolver=letsencrypt" -"traefik.http.routers.frontend.priority=10" -"traefik.http.services.frontend.loadbalancer.server.port=80"

  redis:
    image: redis:7-alpine
    container_name: mvp-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes", "--maxmemory", "256mb", "--maxmemory-policy", "allkeys-lru"]
    volumes:
      - redis_data:/data
    networks: [web]
    labels:
      - "traefik.enable=false"

volumes:
  traefik_letsencrypt:
  redis_data: